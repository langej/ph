name: Build and Push Dist

on:
    pull_request:
        types: [closed]

jobs:
    build-and-push:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Bun
              uses: oven-sh/setup-bun@v1

            - name: Install dependencies
              run: bun install

            - name: Build project
              run: bun run build

            - name: Check for changes in dist
              id: check_changes
              run: |
                  if git diff --quiet dist/; then
                    echo "changes=false" >> $GITHUB_OUTPUT
                  else
                    echo "changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: Create Pull Request for dist update
              if: steps.check_changes.outputs.changes == 'true'
              id: create_pr
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: 'Update dist after PR merge'
                  branch: dist-update-after-pr
                  title: 'Update dist after PR merge'
                  body: 'Automatic update of the dist directory after PR merge.'
                  base: main
                  add-paths: dist
                  delete-branch: true

            - name: Enable PR automerge
              if: steps.check_changes.outputs.changes == 'true'
              uses: peter-evans/enable-pull-request-automerge@v3
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
                  merge-method: squash
